---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Ordinary Geostatistics (GC-Distance)
Here, I will explore the variogram and more traditional fits of our data focusing on greater circle distance.  


## Spatial Autocorrelation EDA for Gaussian Processes


```{r}
library(tidyverse)
library(raster)
library(geoR)
```
```{r}
drcsmpls <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/distance_data/drcsmpls_foruse.rds") %>%
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::select(c("id", "hv001")) %>% 
  dplyr::rename(name = id)

mtdt <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/sample_metadata.rds") %>% 
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::rename(name = id) %>% 
  dplyr::select(c("name", "country", "hv001", "adm1name", "longnum", "latnum")) %>% 
  dplyr::filter(name %in% drcsmpls$name)

# map bases
DRCprov <- sf::st_as_sf(readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/gadm/gadm36_COD_1_sp.rds"))
load("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/space_mips_maps_bases.rda")

# drc cities
drccites <- readxl::read_excel("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/DRC_city_coordinates.xlsx") %>% 
  dplyr::mutate(latnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,1] ),
                longnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,2] ) 
                )

# dhs coord points
ge <- sf::st_as_sf(readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/raw_data/dhsdata/datasets/CDGE61FL.rds")) %>% 
  magrittr::set_colnames(tolower(colnames(.))) %>% 
  dplyr::rename(hv001 = dhsclust) 

```

```{r}
# ibd
ibD <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/bigbarcode_genetic_data/mipanalyzer.DRCibD_polarized_biallelic_processed.long.rds")

# log2 IBD measure
ibD <- ibD %>% 
  dplyr::mutate(malecotf_gens = -log2(malecotf),
                malecotf_gens_inv = 1/malecotf_gens)

```

```{r}
cent <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/centrality_measures/centrality_final_wi_and_knn5.RDS")

```

## Moran's I for Centrality
```{r}

#......................
# Pull in Moran's I Results
#......................

moranI_ret <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/results/simresults/moransI_testsdf.RDS")


moranI_ret$Istatistic <- purrr::map(moranI_ret$moranIret, "statistic")
moranI_ret$pvalue <- purrr::map(moranI_ret$moranIret, "p.value")

moranI_ret <- moranI_ret %>% 
  dplyr::select(-c("moranIret")) %>% 
  tidyr::unnest(cols = c("Istatistic", "pvalue"))

knitr::kable(moranI_ret)


```


## Variogram for Centrality
N.B. for variogram am using a box-cox transformation based on the fit of the centrality versus an intercept. 

### Weighted
```{r, results='asis'}
cent.jitt <- cent
geoR::dup.coords(as.matrix(cent.jitt[,c("longnum", "latnum")]))

cent.jitt[,c("longnum", "latnum")] <- geoR::jitterDupCoords(as.matrix(cent.jitt[,c("longnum", "latnum")]),
                                                            max = 1, min = 0.01)

cent.weighted.geodata <- geoR::as.geodata(obj = cent.jitt,
                                          coords.col = c("longnum", "latnum"),
                                          data.col = "centrality_pr_wi")

plot(cent.weighted.geodata)

```

### Pruned
```{r, results='asis'}

cent.pruned.geodata <- geoR::as.geodata(obj = cent.jitt,
                                        coords.col = c("longnum", "latnum"),
                                        data.col = "centrality_pr_knn5")

plot(cent.pruned.geodata)

```


## Cent-Variogram
```{r, results='asis'}
# fit var
lambda <- geoR::boxcoxfit(object = cent.weighted.geodata[[2]])

cent.vario.wi <- geoR::variog(cent.weighted.geodata,
                           bin.cloud = T,
                           lambda = lambda$lambda)

par(mfrow = c(1,3))
points(cent.weighted.geodata, xlab = "Coord X", 
       ylab = "Coord Y",
       cex.max = 0.7, col = gray(seq(1, 0.1, l = 100)),
       pt.divide = "equal")
plot(cent.vario.wi)

plot(cent.vario.wi, bin.cloud = T)
mtext("Empirical Variogram for Weighted Cent", side = 3,  line = -6, outer = TRUE)

graphics.off()



# fit var
lambda <- geoR::boxcoxfit(object = cent.pruned.geodata[[2]])

cent.vario.pr <- geoR::variog(cent.pruned.geodata,
                           bin.cloud = T,
                           lambda = lambda$lambda)

par(mfrow = c(1,3))
points(cent.pruned.geodata, xlab = "Coord X", 
       ylab = "Coord Y",
       cex.max = 0.7, col = gray(seq(1, 0.1, l = 100)),
       pt.divide = "equal")
plot(cent.vario.pr)

plot(cent.vario.pr, bin.cloud = T)
mtext("Empirical Variogram for Pruned Cent", side = 3,  line = -6, outer = TRUE)

graphics.off()

```
This does not indicate a great degree (if any) spatial structuring for either of the centrality measures. The classic variogram should follow a log-curve and have a sill that is reached at some distance. Of note, the potential nugget effect here is huge.  



#### Estimation of Variogram Parameters
I.e. nugget effect, sill, and range. Will test a Matern and Exponential Covariance and compare. 

##### Weighted
```{r}
#..........................
# Maximum Likelihood
#..........................
ml.exp <- likfit(cent.weighted.geodata, 
                 ini = c(1, 0.5),
                 cov.model = "exp",
                 fix.nugget = F, 
                 nugget = 0,
                 fix.kappa = F)

ml.matern <- likfit(cent.weighted.geodata, 
                    ini = c(1, 0.5),
                    cov.model = "matern",
                    fix.nugget = F, 
                    nugget = 0,
                    fix.kappa = F)

#..........................
# OLS
#..........................

ols.exp <- variofit(cent.weighted.geodata, 
                    ini = c(1, 0.5),
                    cov.model = "exp",
                    fix.nugget = F, 
                    nugget = 0,
                    fix.kappa = F) 

ols.matern <- variofit(cent.weighted.geodata, 
                       ini = c(1, 0.5),
                       cov.model = "matern",
                       fix.nugget = F, 
                       nugget = 0,
                       fix.kappa = F)



par(mfrow = c(1, 2))
plot(cent.vario.wi, main = "Maximum Likelihood Estimation")
lines(ml.exp, max.dist = 20, lty = 1, lwd = 2)
lines(ml.matern, max.dist = 20, lty = 2, lwd = 2, col = "red")
legend(2, 4, legend = c("Exp", "Matern"), 
       lty = c(1, 2), col = c("black", "red"), cex = 0.7)

plot(cent.vario.wi, main = "Ordinary Least Square")
lines(ols.exp, max.dist = 20, lty = 1, lwd = 2)
lines(ols.matern, max.dist = 20, lty = 2, lwd = 2, col = "red")
legend(2, 4, legend = c("Exp", "Matern"), 
       lty = c(1, 2), col = c("black", "red"), cex = 0.7)

graphics.off()

```


##### Pruned
```{r}

#..........................
# Maximum Likelihood
#..........................
ml.exp <- likfit(cent.pruned.geodata, 
                 ini = c(1, 0.5),
                 cov.model = "exp",
                 fix.nugget = F, 
                 nugget = 0,
                 fix.kappa = F)

ml.matern <- likfit(cent.pruned.geodata, 
                    ini = c(1, 0.5),
                    cov.model = "matern",
                    fix.nugget = F, 
                    nugget = 0,
                    fix.kappa = F)

#..........................
# OLS
#..........................

ols.exp <- variofit(cent.pruned.geodata, 
                    ini = c(1, 0.5),
                    cov.model = "exp",
                    fix.nugget = F, 
                    nugget = 0,
                    fix.kappa = F) 

ols.matern <- variofit(cent.pruned.geodata, 
                       ini = c(1, 0.5),
                       cov.model = "matern",
                       fix.nugget = F, 
                       nugget = 0,
                       fix.kappa = F)



par(mfrow = c(1, 2))
plot(cent.vario.pr, main = "Maximum Likelihood Estimation")
lines(ml.exp, max.dist = 20, lty = 1, lwd = 2)
lines(ml.matern, max.dist = 20, lty = 2, lwd = 2, col = "red")
legend(2, 4, legend = c("Exp", "Matern"), 
       lty = c(1, 2), col = c("black", "red"), cex = 0.7)

plot(cent.vario.pr, main = "Ordinary Least Square")
lines(ols.exp, max.dist = 20, lty = 1, lwd = 2)
lines(ols.matern, max.dist = 20, lty = 2, lwd = 2, col = "red")
legend(2, 4, legend = c("Exp", "Matern"), 
       lty = c(1, 2), col = c("black", "red"), cex = 0.7)

graphics.off()

```




