---
output: html_document
editor_options: 
  chunk_output_type: console
---

# IBD, Meiotic Siblings
In this analysis, we will look at pairs that have more  relatedness than would be expected for a recombining pathogen (e.g. greater than or equal to 0.5 relatedness, so at least meiotic siblings).

```{r, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide',
                      fig.align = 'center', fig.width = 8, fig.height = 8)
```
```{r}
library(tidyverse)
library(raster)
library(tidygraph)
library(ggraph)
source("~/Documents/GitHub/Space_the_Final_Miptier/R/themes.R")
```

```{r}
permsparams <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/results/meiotic_null_dist/_rslurm_meiotic_sib_permutations/params.RDS")

# get all files
permsfiles <- list.files("~/Documents/GitHub/Space_the_Final_Miptier/results/meiotic_null_dist/_rslurm_meiotic_sib_permutations/",
                           pattern = ".RDS", full.names = T)
permsfiles <- permsfiles[!grepl("f.RDS|params.RDS", permsfiles)]


permsfilesdf <- tibble::tibble(
  path = permsfiles
  ) %>% 
  dplyr::mutate(fileord = stringr::str_extract(path, "[0-9]+"),
                fileord = as.numeric(fileord)) %>% 
  dplyr::arrange(fileord)

# now get results 
permsparams$results <- unlist(purrr::map(permsfilesdf$path, readRDS), 
                             recursive = F)


perms <- permsparams %>% 
  dplyr::select(c("name", "results"))



```

```{r}
drcsmpls <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/distance_data/drcsmpls_foruse.rds") %>%
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::select(c("id", "hv001")) %>% 
  dplyr::rename(name = id)

mtdt <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/sample_metadata.rds") %>% 
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::rename(name = id) %>% 
  dplyr::select(c("name", "country", "hv001", "adm1name", "longnum", "latnum")) %>% 
  dplyr::filter(name %in% drcsmpls$name)

# drc prov for plot
DRCprov <- sf::st_as_sf(readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/gadm/gadm36_COD_1_sp.rds"))
# load pretty map aesthetics 
load("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/space_mips_maps_bases.rda")

```
```{r}
ibD <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/bigbarcode_genetic_data/mipanalyzer.DRCibD_polarized_biallelic_processed.long.rds")

# log2 IBD measure
ibD <- ibD %>% 
  dplyr::mutate(malecotf_gens = -log2(malecotf),
                malecotf_gens_inv = 1/malecotf_gens)


```


<!-- TODO all above should be pre-done -->

### Meiotic Pair Plot
```{r}
#..............................................................
# Idenity samples with IBD that are greater than half the
# genome (i.e. at or above meiotic siblings)
# These represent likely recent transmission events
#..............................................................
ibD.meiotic <- ibD %>% 
  dplyr::filter(malecotf >= 0.5)
ibdmeioticsmpls <- as.character(ibD.meiotic$smpl1)
ibdmeioticsmpls <- c(ibdmeioticsmpls, as.character(ibD.meiotic$smpl2))
# coord pts
coords.pts <- mtdt %>% 
  dplyr::select(c("name", "hv001", "longnum", "latnum")) %>% 
  dplyr::filter(name %in% ibdmeioticsmpls)
# add spatial jitter
coords.pts$long_jitter <- coords.pts$long + runif(n = nrow(coords.pts), min = -1e-3, max = 1e-3)
coords.pts$lat_jitter <- coords.pts$lat + runif(n = nrow(coords.pts), min = -1e-3, max = 1e-3)

# long connections
colnames(coords.pts)[1] <- "smpl1"
ibD.meiotic <- dplyr::left_join(ibD.meiotic, coords.pts, by = "smpl1")
colnames(coords.pts)[1] <- "smpl2"
ibD.meiotic <- dplyr::left_join(ibD.meiotic, coords.pts, by = "smpl2")
colnames(coords.pts)[1] <- "name"


ibD.meiotic_plot <- ggplot() +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  # prettybasemap_nodrc_dark +
  geom_curve(data = ibD.meiotic, alpha = 0.5, size = 1.1,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof)) +
  geom_point(data = coords.pts, aes(x = long_jitter, y = lat_jitter), color = "#d9d9d9", size = 2, show.legend = F, alpha = 0.8) +
  scale_color_viridis_c("IBD Generations", option="plasma", direction = -1) 



jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_network_abovemeitic.jpg",
     height = 8, width = 8, units = "in", res = 500)
plot(ibD.meiotic_plot)
graphics.off()


```

```{r, results='asis'}
plot(ibD.meiotic_plot)
```

### Meiotic Pair Table
```{r, results=  'asis'}

ibD_meiotic_table <- ibD.meiotic %>% 
  dplyr::select(c("smpl1", "smpl2", "malecotf", "hv001.x", "hv001.y"))

mtdt.join <- mtdt %>% 
  dplyr::select(c("hv001", "adm1name")) %>% 
  filter(!duplicated(.)) %>% 
  dplyr::rename(hv001.x = hv001) 
ibD_meiotic_table <- dplyr::left_join(ibD_meiotic_table, mtdt.join, by = "hv001.x")

mtdt.join <- mtdt.join %>% 
  dplyr::rename(hv001.y = hv001.x)
ibD_meiotic_table <- dplyr::left_join(ibD_meiotic_table, mtdt.join, by = "hv001.y")


DT::datatable(ibD_meiotic_table, extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 20,
              dom = 'Bfrtip', 
              buttons = c('csv')))
  
```


## Hypotheses
We have three major questions regarding these strong genetic connections:  
  
1. Are these connections more frequently "local" (w/in cluster) or "long-range"?
2. Are these connections from a "sink-source" scenario where low-prevalence and high-prevalence regions seemed to be linked?
3. Are these connections more frequently found in cities?

## IBD Meiotic and Local vs. Long-Range Transmission

Here we can look at IBD connections by cluster (color).
```{r, results='asis'}
# convert to network
ibD.meiotic.network <- ibD.meiotic %>% 
  tidygraph::as_tbl_graph(., directed = F) %>% 
  tidygraph::activate("nodes") %>% 
  dplyr::left_join(., y = mtdt, by = "name") 

# plot
ibD.meiotic.network %>%
  ggraph(layout = "kk") +
  geom_edge_link(aes(color  = malecotf), width = 1.2, alpha = 0.5) +
  scale_edge_color_viridis("Pairwise IBD") +
  geom_node_point(aes(shape = factor(hv001), fill = factor(hv001)), show.legend = F) +
  scale_shape_manual(values = rep(c(21, 22, 23, 24, 25), 12)) +
  #geom_node_text(aes(label = hv001), nudge_y = 0.1) +
  theme_graph() +
  theme(legend.position = "bottom",
        legend.title = element_text(family = "Helvetica", vjust = 0.85, size = 13, face = "bold"),
        legend.text = element_text(family = "Helvetica", hjust = 1, size = 12, face = "bold", angle = 90))

```

**Visualize pairs with only one connection**. 
```{r, results='asis'}

meiotic_clst.uni <- ibD.meiotic.network %>% 
  tidygraph::activate("nodes") %>%
  dplyr::mutate(node_edge_density = igraph::degree(.)) %>%
  dplyr::filter(c(node_edge_density == 1 | 
                     name %in% c("3002B1W5E", "Z2H3M")# catch violation of transitivity 
                    ) 
                )

meiotic_clst.uni.plotobj <- meiotic_clst.uni %>% 
  ggraph(layout = "kk") +
  geom_node_point(aes(shape = factor(hv001), fill = factor(hv001)), show.legend = F) +
  geom_edge_link(aes(color  = malecotf), width = 1.2, alpha = 0.5) +
  scale_edge_color_viridis("Pairwise IBD") +
  scale_shape_manual(values = rep(c(21, 22, 23, 24, 25), 12)) +
  geom_node_text(aes(label = hv001), nudge_y = 0.1) +
  theme_graph() +
  theme(legend.position = "bottom",
        legend.title = element_text(family = "Helvetica", vjust = 0.85, size = 13, face = "bold"),
        legend.text = element_text(family = "Helvetica", hjust = 1, size = 12, face = "bold", angle = 90))
plot(meiotic_clst.uni.plotobj)

meiotic_clst.uni %>% 
  ggraph(layout = "kk") +
  geom_edge_link(aes(width  = malecotf), color = "#969696", alpha = 0.5) +
  geom_node_point(aes(color = factor(hv001))) +
  geom_node_text(aes(label = hv001)) +
  theme_graph() 


```

```{r, results='asis'}
meiotic_clst.uni %>% 
  tidygraph::activate(edges) %>% 
  tibble::as_tibble(.) %>% 
   DT::datatable(.,
                rownames = F,
                options = list(
                  searching = F,
                  pageLength = 20,
                  dom = 'Bfrtip',
                  buttons = c('csv')))

```

**Visualize pairs with more than one connection**. 
```{r, results='asis'}

meiotic_clst.conn <- ibD.meiotic.network %>% 
  tidygraph::activate("nodes") %>% 
  dplyr::mutate(node_edge_density = igraph::degree(.)) %>% 
  dplyr::filter(node_edge_density > 1) 

meiotic_clst.conn.PlotObj <- meiotic_clst.conn %>% 
  ggraph(layout = "kk") +
  geom_node_point(aes(shape = factor(hv001), fill = factor(hv001)), show.legend = F) +
  geom_edge_link(aes(color  = malecotf), width = 1.2, alpha = 0.5) +
  scale_edge_color_viridis("Pairwise IBD") +
  scale_shape_manual(values = rep(c(21, 22, 23, 24, 25), 12)) +
  geom_node_text(aes(label = hv001), nudge_y = 0.1) +
  theme_graph() +
  theme(legend.position = "bottom",
        legend.title = element_text(family = "Helvetica", vjust = 0.85, size = 13, face = "bold"),
        legend.text = element_text(family = "Helvetica", hjust = 1, size = 12, face = "bold", angle = 90))
plot(meiotic_clst.conn.PlotObj)

meiotic_clst.conn %>% 
  ggraph(layout = "kk") +
  geom_edge_link(aes(width  = malecotf), color = "#969696", alpha = 0.5) +
  geom_node_point(aes(color = factor(hv001))) +
  geom_node_text(aes(label = hv001)) + 
  theme_graph() 

```

```{r, results='asis'}
meiotic_clst.conn %>% 
  tidygraph::activate(edges) %>% 
  tibble::as_tibble(.) %>% 
   DT::datatable(.,
                rownames = F,
                options = list(
                  searching = F,
                  pageLength = 20,
                  dom = 'Bfrtip',
                  buttons = c('csv')))

```


**Let's look at that same information but on a map**.  

```{r, results='asis'}

meiotic_clst.uni.nodes <- meiotic_clst.uni %>% 
  tidygraph::activate(., "nodes") %>% 
  tibble::as_tibble(.) 

meiotic_clst.uni.edges <- meiotic_clst.uni %>% 
  tidygraph::activate(., "edges") %>% 
  tibble::as_tibble(.) 


meiotic_clst.one.conn.map <- ggplot() +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  geom_curve(data = meiotic_clst.uni.edges,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof),
             alpha = 0.5, size = 1.1) +
  geom_point(data = meiotic_clst.uni.nodes,
             aes(x = longnum, y = latnum, fill = factor(hv001)), shape = 21, show.legend = F) +
  scale_color_viridis_c("Pairwise IBD", option="plasma", direction = -1) + 
  ggtitle("IBD Pairs with only One Connection")

plot(meiotic_clst.one.conn.map)

```


```{r, results='asis'}

meiotic_clst.conn.nodes <- meiotic_clst.conn %>% 
  tidygraph::activate(., "nodes") %>% 
  tibble::as_tibble(.) 

meiotic_clst.conn.edges <- meiotic_clst.conn %>% 
  tidygraph::activate(., "edges") %>% 
  tibble::as_tibble(.) 


ibd.moreconn.map <- ggplot() +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  geom_curve(data = meiotic_clst.conn.edges,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof),
             alpha = 0.5, size = 1.1) +
  geom_point(data = meiotic_clst.conn.nodes,
             aes(x = longnum, y = latnum, fill = factor(hv001)), shape = 21, show.legend = F) +
  scale_color_viridis_c("Pairwise IBD", option="plasma", direction = -1) + 
  ggtitle("IBD Pairs with more than One Connection")
plot(ibd.moreconn.map)


```

```{r}

ibd.moreconn.map <- 
  # prettybasemap_nodrc_dark + 
  ibd.moreconn.map + 
  theme(plot.title = element_blank()) 

meiotic_clst.one.conn.map <- 
 # prettybasemap_nodrc_dark + 
  meiotic_clst.one.conn.map + 
  theme(plot.title = element_blank()) 


jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_network_IBDpairwise_connections.jpg",
     height = 8, width = 11, units = "in", res = 500)
cowplot::plot_grid(meiotic_clst.uni.plotobj, meiotic_clst.conn.PlotObj,
                   meiotic_clst.one.conn.map, ibd.moreconn.map,
                   nrow = 2, align = "v", labels = c("(A)", "(B)", "(C)", "(D)"))
graphics.off()

```


### Local Transmission Events
Now mark clusters with local transmission events (regardless of number of connections). 
```{r, results='asis'}

local_trans_plot <- ibD.meiotic.network %>% 
  tidygraph::activate(., "edges") %>% 
  dplyr::filter(hv001.x == hv001.y) %>% 
  ggplot() +
  # prettybasemap_nodrc_dark +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  geom_jitter(alpha = 0.5, size = 1.1,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 color = malectof),
             width = 0.05, height = 0.05) +
  scale_color_viridis_c("Pairwise IBD", option="plasma", direction = -1) 

plot(local_trans_plot)
```

#### Quadrad
Is the quadrad from individuals in the same household?
```{r, results='asis'}

quadrad <- meiotic_clst.conn.nodes %>% 
  dplyr::filter(hv001 == 284)

dt.geo <- readRDS(file = "~/Documents/GitHub/VivID_Epi/data/derived_data/vividepi_recode_completecases.rds") %>% 
  dplyr::select(c("hivrecode_barcode", "houseid"))

quadrad %>% 
  dplyr::rename(hivrecode_barcode = name) %>% 
  dplyr::mutate(hivrecode_barcode = tolower(hivrecode_barcode)) %>% 
  dplyr::left_join(., dt.geo, by = c("hivrecode_barcode")) %>% 
  dplyr::select(c("hivrecode_barcode", "hv001", "adm1name", "houseid")) %>% 
  knitr::kable(.)

```


### Long Transmission Events
Now mark clusters with long transmission events (regardless of number of connections). 
```{r, results='asis'}

# note tidygraph prunes edges and nodes independently
notsameclst.edges <- ibD.meiotic.network %>% 
  tidygraph::activate(., "edges") %>% 
  dplyr::filter(hv001.x != hv001.y) %>% 
  tibble::as_tibble(.) 

notsameclst.nodes <- ibD.meiotic.network %>% 
  tidygraph::activate(., "nodes") %>% 
  tibble::as_tibble(.) %>% 
  dplyr::filter(hv001 %in% c(notsameclst.edges$hv001.x, notsameclst.edges$hv001.y))


long_trans_plot <- ggplot() +
  # prettybasemap_nodrc_dark +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
   geom_curve(data = notsameclst.edges,
              aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof),
             alpha = 0.5, size = 1.1) +
  geom_point(data = notsameclst.nodes,
             aes(x = longnum, y = latnum, fill = factor(hv001)), shape = 21, show.legend = F) + 
  scale_color_viridis_c("Pairwise IBD", option="plasma", direction = -1) 

plot(long_trans_plot)
```


```{r}
jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_network_local_long_trans_map.jpg",
     height = 8, width = 11, units = "in", res = 500)
cowplot::plot_grid(local_trans_plot, 
                   long_trans_plot,
                   nrow = 1, align = "v", labels = c("(A)", "(B)"))
graphics.off()
```


Interesting to look at edge density. 

```{r, results='asis'}


notsameclst.nodes <- ibD.meiotic.network %>% 
  tidygraph::activate(., "nodes") %>% 
  dplyr::mutate(node_edge_density = igraph::degree(.)) %>%
  tibble::as_tibble(.) %>% 
  dplyr::filter(hv001 %in% c(notsameclst.edges$hv001.x, notsameclst.edges$hv001.y))


ggplot() +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  geom_point(data = notsameclst.nodes,
             aes(x = longnum, y = latnum, 
                 color = factor(hv001),
                 size = node_edge_density), alpha = 0.5, show.legend = F) + 
  ggtitle("Long Transmission Events") + 
  theme(legend.position = "bottom")


ggplot() +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  geom_point(data = notsameclst.nodes,
             aes(x = longnum, y = latnum, 
                 color = factor(hv001),
                 size = node_edge_density), alpha = 0.5, show.legend = F) + 
  ggrepel::geom_label_repel(data = notsameclst.nodes, 
                            aes(x = longnum, y = latnum,
                                label = hv001)) +
  ggtitle("Long Transmission Events") + 
  theme(legend.position = "bottom")

```



### Permutation Test for Within Cluster

```{r}
perms.clstwthn <- perms %>% 
  dplyr::filter(name == "clstwthn") %>% 
  dplyr::select("results") 

# lift over result
perms.clstwthn$wthncount <- purrr::map(perms.clstwthn$results, function(x){
  return(sum(x == 0)) # if it was the same cluster, hv001 - hv001 would be 0 
})

perms.clstwthn <- perms.clstwthn %>% 
  tidyr::unnest(cols = "wthncount")


```

```{r, results='asis'}


# housekeeping for text below
true_count_meiotic_wthnclst <- ibD.meiotic.network %>% 
  tidygraph::activate(., "edges") %>% 
  dplyr::filter(hv001.x == hv001.y) %>% 
  tibble::as_tibble(.) %>% 
  nrow(.) %>% as.numeric(.)

perms.clstwthn.plotObj <- ggplot() +
  geom_bar(data = perms.clstwthn, aes(x = wthncount, y = ..count..), color = "#969696") +
  geom_vline(xintercept = true_count_meiotic_wthnclst, color = "#cb181d") +
  ggtitle("Permuted Within Cluster Pairs Expected to be at least Meiotic Sibs") +
  xlab("Meiotic Sib within Cluster Count") + ylab("Sim Count") +
  plot_theme

plot(perms.clstwthn.plotObj)


```

### Permutation Test for Between Cluster

```{r}
perms.clstbtwen <- perms %>% 
  dplyr::filter(name == "clstwthn") %>% 
  dplyr::select("results") 

# lift over result
perms.clstbtwen$wthncount <- purrr::map(perms.clstbtwen$results, function(x){
  return(sum(x != 0)) # if it was the same cluster, hv001 - hv001 would be 0 
})

perms.clstbtwen <- perms.clstbtwen %>% 
  tidyr::unnest(cols = "wthncount")


```

```{r, results='asis'}

# housekeeping for text below
true_count_meiotic_btwnclst <- ibD.meiotic.network %>% 
  tidygraph::activate(., "edges") %>% 
  dplyr::filter(hv001.x != hv001.y) %>% 
  tibble::as_tibble(.) %>% 
  nrow(.) %>% as.numeric(.)


# geom density gets stretched out the curve density so need to set xlim
summary(perms.clstbtwen$wthncount)
true_count_meiotic_btwnclst
# so need to add 4 to each side to get exact min, will add 5 for balance

# get base plot
btwnclst.plotObj <- ggplot() +
  geom_density(data = perms.clstbtwen, aes(x = wthncount), color = "#969696", fill = "#969696") +
  xlim(42, 71)

# get ggplot data
perms.clst.pval <- quantile(perms.clstbtwen$wthncount, probs = c(0.025, 0.975))
# extract ggplot data
ggplotdat <- ggplot2::ggplot_build(btwnclst.plotObj)$data[[1]]

# now get areas
perms.clst.lowertail <- ggplotdat %>% 
  dplyr::filter(x <= perms.clst.pval[[1]])
perms.clst.uppertail <- ggplotdat %>% 
  dplyr::filter(x >= perms.clst.pval[[2]])

# make final plot
btwnclst.plotObj <- btwnclst.plotObj +
  geom_area(data = perms.clst.lowertail, aes(x = x, y = y), fill = "#4292c6", color = "#4292c6") +
  geom_area(data = perms.clst.uppertail, aes(x = x, y = y), fill = "#4292c6", color = "#4292c6") +
  geom_vline(xintercept = true_count_meiotic_btwnclst, color = "#cb181d") +
  ggtitle("Permuted Between Cluster Pairs Expected to be at least Meiotic Sibs") +
  xlab("Meiotic Sib Between Cluster Count") + ylab("Sim Proportion") +
  plot_theme

plot(btwnclst.plotObj)

```


Overall, we detected `r nrow(ibD.meiotic)` pairs of samples that had at least meiotic similarity. Of these, `r paste(true_count_meiotic_wthnclst)` were within the same clusters, while `r nrow(notsameclst.edges)` were between clusters.   
**This tells us what we already know**. 

## Focus in on Long-Range Pairs
```{r}
# liftover to just long range
ibD.meiotic.network.edges <- ibD.meiotic.network %>% 
  tidygraph::activate(., "edges") %>% 
  dplyr::filter(hv001.x != hv001.y) %>% 
  tibble::as_tibble(.)

```

### IBD Meiotic Siblings and Urbanicity

#### Visualization of IBD & Urban
**First let's visualize the meiotic connections over rasters of urbanicity**. 

```{r}
# extra for plotting
drccities <- readxl::read_excel("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/DRC_city_coordinates.xlsx") %>% 
  dplyr::mutate(latnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,1] ),
                longnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,2] ) 
                )
ge <- sf::st_as_sf(readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/raw_data/dhsdata/datasets/CDGE61FL.rds")) %>% 
  magrittr::set_colnames(tolower(colnames(.))) %>% 
  dplyr::rename(hv001 = dhsclust) %>% 
  dplyr::select(c("hv001", "urban_rura"))
sf::st_geometry(ge) <- NULL

# extract out coordinate information and join in urban rural data
urban.pts <- sf::st_as_sf(coords.pts, coords = c("longnum", "latnum"), crs = 4326)
urban.pts <- urban.pts %>% 
  dplyr::filter(!duplicated(hv001)) %>% 
  dplyr::left_join(., ge, by = "hv001") %>% 
  dplyr::mutate(urban_rura_ext = ifelse(urban_rura == "R", 10000, 2000))


urban <- raster::raster("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/urbanicity_raster/urbanicity.grd")


urbanmedian <- rep(NA, nrow(urban.pts)) 
for (i in 1:nrow(urban.pts)) {
  urbanmedian[i] <-  raster::extract(x = urban,
                                   y = sf::as_Spatial(urban.pts$geometry[i]),
                                   buffer = urban.pts$urban_rura_ext[i],
                                   fun = median, na.rm = T
  )
}
  
urban.pts <- urban.pts %>% 
  dplyr::mutate(long = sf::st_coordinates(geometry)[,1],
                lat = sf::st_coordinates(geometry)[,2],
                urbanmedian = urbanmedian)

```

```{r}

ibD.meiotic_plot_urbanrstr <- ggplot() +
  ggspatial::layer_spatial(data = urban, aes(fill = stat(band1))) +
  geom_sf(data = DRCprov, color = "#737373", fill = NA, size = 0.05) +
  scale_fill_distiller("Urbanicity", type = "div", palette = "RdYlBu") +
  # prettybasemap_nodrc_dark +
  geom_curve(data = ibD.meiotic.network.edges, alpha = 0.5, size = 1,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof)) +
  geom_point(data = urban.pts, aes(x = long_jitter, y = lat_jitter), 
             size = 2, shape = 21, stroke = 0.5, fill = NA) +
  scale_color_viridis_c("IBD Generations", option="plasma", direction = -1) 


jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_network_abovemeitic_citylights_raster.jpg",
     height = 8, width = 8, units = "in", res = 500)
plot(ibD.meiotic_plot)
graphics.off()


```

```{r, results='asis'}
plot(ibD.meiotic_plot)
```


```{r}

ibD.meiotic_plot <- ggplot() +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  #prettybasemap_nodrc_dark +
  geom_curve(data = ibD.meiotic.network.edges, alpha = 0.5, size = 1.1,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof)) +
  geom_point(data = urban.pts, aes(x = long_jitter, y = lat_jitter, 
                                    fill = urbanmedian), 
             size = 2, shape = 21, stroke = 0) +
  scale_color_viridis_c("Pairwise IBD", option="plasma", direction = -1) +
  scale_fill_distiller("Median Urbanicity", type = "div", palette = "RdYlBu") 



jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_network_abovemeitic_citylights.jpg",
     height = 8, width = 8, units = "in", res = 500)
plot(ibD.meiotic_plot)
graphics.off()

```

```{r, results='asis'}
plot(ibD.meiotic_plot)
```

```{r}
ibD.meiotic_plot <- ggplot() +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  #prettybasemap_nodrc_dark +
  geom_curve(data = ibD.meiotic.network.edges, alpha = 0.5, size = 1.1,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof)) +
  geom_point(data = urban.pts, aes(x = long_jitter, y = lat_jitter, 
                                    fill = urbanmedian, shape = factor(urban_rura)), 
             size = 2) +
  geom_point(data = drccities, aes(x = longnum, y=latnum), color = "#f0f0f0") + 
  ggrepel::geom_text_repel(data = drccities, aes(label = city, x = longnum, y=latnum), 
                           hjust = 0.5, vjust = 0.5, nudge_y = 0.3, fontface = "bold", color = "#f0f0f0") +
  scale_color_viridis_c("Pairwise IBD", option="plasma", direction = -1) +
  scale_fill_distiller("Median Urbanicity", type = "div", palette = "RdYlBu") +
  scale_shape_manual("Urban-Rural", values = c(21, 24))



jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_network_abovemeitic_citylights_cites_dhsurbanrural.jpg",
     height = 8, width = 8, units = "in", res = 500)
plot(ibD.meiotic_plot)
graphics.off()


```

```{r, results='asis'}
plot(ibD.meiotic_plot)
```


**Consider Urbanicity as a Binary**. 
Urbanitity in the top third percentile is city and below is rural. 

```{r, results='asis'}

urbancatch <- raster::raster("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/urbanicity_raster/urbanicity_binary.grd")


ibD.meiotic_plot_urban_binary_rstr <- ggplot() +
  ggspatial::layer_spatial(data = urbancatch, aes(fill = stat(band1))) +
  geom_sf(data = DRCprov, color = "#737373", fill = NA, size = 0.05) +
  scale_fill_distiller("Urbanicity Binary", type = "div", palette = "RdYlBu") +
  # prettybasemap_nodrc_dark +
  geom_curve(data = ibD.meiotic.network.edges, alpha = 0.5, size = 1.1,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof)) +
  geom_point(data = urban.pts, aes(x = long_jitter, y = lat_jitter), 
             size = 2, shape = 21, stroke = 0.5, fill = NA) +
  scale_color_viridis_c("Pairwise IBD", option="plasma", direction = -1) 

plot(ibD.meiotic_plot_urban_binary_rstr)
```

```{r, results='asis'}

cowplot::plot_grid(ibD.meiotic_plot_urbanrstr, ibD.meiotic_plot_urban_binary_rstr,
                   align = "h", nrow = 1, labels = c("(A)", "(B)")
                   )
```

```{r}

jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_network_abovemeitic_citylights_urbbinary_cowplot.jpg",
     height = 8, width = 11, units = "in", res = 500)
cowplot::plot_grid(ibD.meiotic_plot_urbanrstr, ibD.meiotic_plot_urban_binary_rstr,
                   align = "h", nrow = 1, labels = c("(A)", "(B)")
                   )
graphics.off()

```

```{r}
urban.cities <- ggplot() +
  ggspatial::layer_spatial(data = urban, aes(fill = stat(band1))) +
  geom_sf(data = DRCprov, color = "#737373", fill = NA, size = 0.05) +
  # prettybasemap_nodrc_dark +
  ggrepel::geom_text_repel(data = drccities, aes(label = city, x = longnum, y=latnum), 
                           hjust = 0.5, vjust = 0.5, nudge_y = 0.8, fontface = "bold") +
 geom_point(data = drccities, aes(x = longnum, y=latnum), shape = 21, fill = NA) +
  scale_fill_distiller("Urbanicity", type = "div", palette = "RdYlBu") 
  


jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_cities_citylights_raster.jpg",
     height = 8, width = 8, units = "in", res = 500)
plot(urban.cities)
graphics.off()

```
```{r, results='asis'}
plot(urban.cities)
```

#### Permutation Test for Urbanicity
```{r}
perms.urb <- perms %>% 
  dplyr::filter(name == "urban") %>% 
  dplyr::select("results") 

# process data
# look at medians here since non-normal
perms.urb <- perms.urb %>% 
  dplyr::mutate(
    urbanmediandiff = purrr::map(results, median)
  ) %>% 
  tidyr::unnest(cols = urbanmediandiff)

# observed data
# match .x
urban.pts <- urban.pts %>% 
  dplyr::rename(hv001.x = hv001)
obsurb <- ibD.meiotic.network.edges %>% 
  dplyr::left_join(., y = urban.pts, by = "hv001.x")

# match .y 
urban.pts <- urban.pts %>% 
  dplyr::rename(hv001.y = hv001.x)
# get diff
obsurb <- dplyr::left_join(obsurb, urban.pts, by = "hv001.y") %>% 
  dplyr::select(c(dplyr::starts_with("malecot"),
                  "hv001.x", "hv001.y",
                  "urbanmedian.x", "urbanmedian.y")) %>% 
  dplyr::mutate(urbanmeadiandiff =  (urbanmedian.x - urbanmedian.y)^2)


obsurb.urbnmediandiff <- mean(obsurb$urbanmeadiandiff)


```

```{r, results='asis'}

# geom_density stretches the density curve based on the observed data
summary(perms.urb$urbanmediandiff)
obsurb.urbnmediandiff
# will fix at 0 and 13 to capture it

urb.perm.plotObj <- ggplot() +
  geom_density(data = perms.urb, aes(x = urbanmediandiff), fill = "#969696", color = "#969696") + 
  xlim(0, 13)

perms.urb.pval <- quantile(perms.urb$urbanmediandiff, probs = c(0.025, 0.975))
# extract ggplot data
ggplotdat <- ggplot2::ggplot_build(urb.perm.plotObj)$data[[1]]

# now get areas
perms.urb.lowertail <- ggplotdat %>% 
  dplyr::filter(x <= perms.urb.pval[[1]])
perms.urb.uppertail <- ggplotdat %>% 
  dplyr::filter(x >= perms.urb.pval[[2]])


urb.perm.plotObj <- urb.perm.plotObj + 
  geom_area(data = perms.urb.lowertail, aes(x = x, y = y), fill = "#4292c6", color = "#4292c6") +
  geom_area(data = perms.urb.uppertail, aes(x = x, y = y), fill = "#4292c6", color = "#4292c6") +
  geom_vline(xintercept = obsurb.urbnmediandiff, color = "#cb181d") +
  ggtitle("Permuted Urbanicity Difference Between Pairs Expected to be at least Meiotic Sibs") +
  xlab("Permuted Urbanicity Median Difference") + ylab("Sim Proportion") +
  plot_theme
  
plot(urb.perm.plotObj)

```

### Meiotic Siblings and Prevalence

#### Visualization of IBD & Prevalence

```{r, results='asis'}

#.............
# Pf Prevalence
#.............
parasiterate <- raster::raster("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/MAPrasters/parasiterate.grd")

# extract out coordinate information and join in prevdata
prev.pts <- sf::st_as_sf(coords.pts, coords = c("longnum", "latnum"), crs = 4326)
prev.pts <- prev.pts %>% 
  dplyr::filter(!duplicated(hv001)) %>% 
  dplyr::left_join(., ge, by = "hv001") %>% 
  dplyr::mutate(urban_rura_ext = ifelse(urban_rura == "R", 10000, 2000))

# cluster 54 has missing when just 2km -- extend to 6km 
prev.pts$urban_rura_ext[prev.pts$hv001 == 54] <- 6000

prevmean <- rep(NA, nrow(prev.pts)) 
for (i in 1:nrow(prev.pts)) {
  prevmean[i] <-  raster::extract(x = parasiterate,
                                   y = sf::as_Spatial(prev.pts$geometry[i]),
                                   buffer = prev.pts$urban_rura_ext[i],
                                   fun = mean, na.rm = T
  )
}
  
prev.pts <- prev.pts %>% 
  dplyr::mutate(long = sf::st_coordinates(geometry)[,1],
                lat = sf::st_coordinates(geometry)[,2],
                prevmean = prevmean)

```

```{r, results='asis'}
ibD.meiotic_plot <- ggplot() +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  ggspatial::layer_spatial(data = parasiterate, aes(fill = stat(band1))) +
  scale_fill_distiller("MAP Pf PR", type = "div", palette = "RdYlBu") +
  #prettybasemap_nodrc_dark +
  geom_curve(data = ibD.meiotic.network.edges, alpha = 0.5, size = 1.1,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof)) +
  geom_point(data = prev.pts, aes(x = long_jitter, y = lat_jitter), 
             size = 2, shape = 21, stroke = 0.1, fill = NA) +
  scale_color_viridis_c("Pairwise IBD", option="plasma", direction = -1) 

plot(ibD.meiotic_plot)
```
```{r}
jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_network_abovemeitic_prevalence_raster.jpg",
     height = 8, width = 8, units = "in", res = 500)
plot(ibD.meiotic_plot)
graphics.off()


```

```{r}

ibD.meiotic_plot <- ggplot() +
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  #prettybasemap_nodrc_dark +
  geom_curve(data = ibD.meiotic.network.edges, alpha = 0.5, size = 1.1,
             aes(x = long_jitter.x, y = lat_jitter.x, 
                 xend = long_jitter.y, yend = lat_jitter.y, 
                 color = malectof)) +
  geom_point(data = prev.pts, aes(x = long_jitter, y = lat_jitter, 
                                    fill = prevmean), 
             size = 2, shape = 21, stroke = 0) +
  scale_color_viridis_c("Pairwise IBD", option="plasma", direction = -1) +
  scale_fill_distiller("MAP Pf PR", type = "div", palette = "RdYlBu") 

plot(ibD.meiotic_plot)
```

```{r}
jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_network_abovemeitic_prevalence_points.jpg",
     height = 8, width = 8, units = "in", res = 500)
plot(ibD.meiotic_plot)
graphics.off()


```

#### Edge Density and Prevalence
```{r}
# get edge density
prev.edge.dens <- ibD.meiotic.network %>% 
  tidygraph::activate(., "nodes") %>% 
  dplyr::mutate(node_edge_density = igraph::degree(.)) %>%
  tibble::as_tibble(.) %>% 
  dplyr::select(c("name", "hv001", "adm1name", "node_edge_density"))

# link prevalence and edge counts
prev.pts.clst <- prev.pts %>% 
  dplyr::select(c("hv001", "prevmean")) %>% 
  dplyr::filter(!duplicated(.))
sf::st_geometry(prev.pts.clst) <- NULL



prev.edge.dens <- dplyr::left_join(x = prev.edge.dens, 
                                   y = prev.pts.clst, 
                                   by = "hv001")

```
```{r, results='asis'}
prev.edge.dens %>% 
  DT::datatable(.,
                rownames = F,
                options = list(
                  searching = F,
                  pageLength = 15,
                  dom = 'Bfrtip',
                  buttons = c('csv')))

```
```{r, results='asis'}
prev.edge.dens %>% 
  ggplot() + 
  geom_point(aes(x = node_edge_density, y = prevmean), size = 2) +
  theme_classic() + 
  ggtitle("Edge Density (by Node) vs. Parasite Rate") + 
  xlab("Edge Density") + ylab("Parasite Rate")
```


#### Permutation Test for Prevalence
```{r}
perms.prev <- perms %>% 
  dplyr::filter(name == "prev") %>% 
  dplyr::select("results") 

# process data
perms.prev <- perms.prev %>% 
  dplyr::mutate(
    prevmeandiff = purrr::map(results, mean)
  ) %>% 
  tidyr::unnest(cols = prevmeandiff)

# observed data
# match .x
prev.pts <- prev.pts %>% 
  dplyr::rename(hv001.x = hv001)
obsprev <- ibD.meiotic.network.edges %>% 
  dplyr::left_join(., y = prev.pts, by = "hv001.x")

# match .y 
prev.pts <- prev.pts %>% 
  dplyr::rename(hv001.y = hv001.x)
# get diff

obsprev <- dplyr::left_join(obsprev, prev.pts, by = "hv001.y") %>% 
  dplyr::select(c(dplyr::starts_with("malecot"),
                  "hv001.x", "hv001.y",
                  "prevmean.x", "prevmean.y")) %>% 
  dplyr::mutate(prevdiff =  (prevmean.x - prevmean.y)^2)


obsprev_meandiff <- mean(obsprev$prevdiff)


```

```{r, results='asis'}

prev.perm.plotObj <- ggplot() +
  geom_density(data = perms.prev, aes(x = prevmeandiff), fill = "#969696", color = "#969696") 

perms.prev.pval <- quantile(perms.prev$prevmeandiff, probs = c(0.025, 0.975))
# extract ggplot data
ggplotdat <- ggplot2::ggplot_build(prev.perm.plotObj)$data[[1]]

# now get areas
perms.prev.lowertail <- ggplotdat %>% 
  dplyr::filter(x <= perms.prev.pval[[1]])
perms.prev.uppertail <- ggplotdat %>% 
  dplyr::filter(x >= perms.prev.pval[[2]])


prev.perm.plotObj <- prev.perm.plotObj + 
  geom_area(data = perms.prev.lowertail, aes(x = x, y = y), fill = "#4292c6", color = "#4292c6") +
  geom_area(data = perms.prev.uppertail, aes(x = x, y = y), fill = "#4292c6", color = "#4292c6") +
  geom_vline(xintercept = obsprev_meandiff, color = "#cb181d") +
  ggtitle("Permuted Prevalence Difference Between Pairs Expected to be at least Meiotic Sibs") +
  xlab("Permuted Prevalence Difference") + ylab("Sim Proportion") +
  plot_theme


plot(prev.perm.plotObj)

```

##### Local Transmission and Prevalence
```{r, results='asis'}

ibD.meiotic_plot <- ggplot() +
  ggspatial::layer_spatial(data = parasiterate, aes(fill = stat(band1))) +
  geom_sf(data = DRCprov, color = "#525252", fill = NA, size = 0.05) +
  scale_fill_distiller("MAP Pf PR", type = "div", palette = "RdYlBu") +
  ggrepel::geom_text_repel(data = drccities, aes(label = city, x = longnum, y=latnum), 
                           hjust = 0.5, vjust = 0.5, nudge_y = 0.8, fontface = "bold") +
 geom_point(data = drccities, aes(x = longnum, y=latnum)) 
  #prettybasemap_nodrc_dark 
  
plot(ibD.meiotic_plot)

```


```{r}

local.trnsm.events <- ibD.meiotic.network %>% 
  tidygraph::activate(., "edges") %>% 
  dplyr::filter(hv001.x == hv001.y)

ibD.meiotic_plot <- ggplot() +
  ggspatial::layer_spatial(data = parasiterate, aes(fill = stat(band1))) +
  geom_sf(data = DRCprov, color = "#525252", fill = NA, size = 0.05) +
  scale_fill_distiller("MAP Pf PR", type = "div", palette = "RdYlBu") +
 geom_point(data = local.trnsm.events, 
            aes(x = longnum.x, y = latnum.x),
            color = "#54278f", alpha = 0.5) +
  ggtitle("Local Transmission and Prev")
  #prettybasemap_nodrc_dark 


```
```{r, results='asis'}
plot(ibD.meiotic_plot)
```


### All Permutations Together
```{r, results='asis'}

perms.clstwthn.plotObj <- perms.clstwthn.plotObj + ggtitle("")
btwnclst.plotObj <- btwnclst.plotObj + ggtitle("")
urb.perm.plotObj <- urb.perm.plotObj + ggtitle("")
prev.perm.plotObj <- prev.perm.plotObj + ggtitle("")


cowplot::plot_grid(perms.clstwthn.plotObj,
                   btwnclst.plotObj,
                   urb.perm.plotObj,
                   prev.perm.plotObj,
                   align = "v")



```
```{r}
jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_abovemeiotic_perms_together.jpg",
     height = 8, width = 11, units = "in", res = 500)
cowplot::plot_grid(perms.clstwthn.plotObj,
                   btwnclst.plotObj,
                   urb.perm.plotObj,
                   prev.perm.plotObj,
                   align = "v")
graphics.off()

```


