---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Within IBD Models
```{r, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide',
                      fig.align = 'center', fig.width = 8, fig.height = 8)
```
```{r}
#---------------------------------------------------------------------------
# Purpose of this script is to do basic epi analyses
#----------------------------------------------------------------------------
library(tidyverse)
library(CARBayes)
library(raster)
source("~/Documents/GitHub/Space_the_Final_Miptier/R/basics.R")
source("~/Documents/GitHub/Space_the_Final_Miptier/R/themes.R")
source("~/Documents/GitHub/Space_the_Final_Miptier/R/pairwise_helpers.R")

```

```{r}
drcsmpls <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/distance_data/drcsmpls_foruse.rds") %>%
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::select(c("id", "hv001")) %>% 
  dplyr::rename(name = id)

mtdt <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/sample_metadata.rds") %>% 
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::rename(name = id) %>% 
  dplyr::select(c("name", "country", "hv001", "adm1name", "longnum", "latnum")) %>% 
  dplyr::filter(name %in% drcsmpls$name)

# drc prov for plot
DRCprov <- sf::st_as_sf(readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/gadm/gadm36_COD_1_sp.rds")) 

# load pretty map aesthetics 
load("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/space_mips_maps_bases.rda")
```

```{r}
#....................................................................................
# Import Genetic Data
#....................................................................................
ibD <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/bigbarcode_genetic_data/mipanalyzer.DRCibD_polarized_biallelic_processed.long.rds")

# log2 IBD measure
ibD <- ibD %>% 
  dplyr::mutate(malecotf_gens = -log2(malecotf),
                malecotf_gens_inv = 1/malecotf_gens)

```

```{r}
#..............................................................
# mk mtdt 
#..............................................................
mtdt.clst <- mtdt %>% 
  dplyr::select(c("name", "hv001")) %>% 
  dplyr::rename(smpl1 = name)

ibD <- dplyr::left_join(ibD, mtdt.clst, by = "smpl1")

# rename
mtdt.clst <- mtdt.clst %>% 
  dplyr::rename(smpl2 = smpl1)
# rejoin
ibD <- dplyr::left_join(ibD, mtdt.clst, by = "smpl2")


#..............................................................
# Import geographic distance and combine with genetic
#..............................................................
distancematrix.cluster <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/distance_data/distancematrix_bycluster.rds")

ibDdist <- long_distance_matrix_join(x=ibD, y=distancematrix.cluster,
                                     by = c("hv001.x", "hv001.y")) %>%
  dplyr::mutate(gcdistance = gcdistance/1e3,
                roaddistance = roaddistance/1e3,
                riverdist = riverdist/1e3,
                riverdist = as.numeric(riverdist)) # remove units


# take care of cluster diagnonals
ibDdist$gcdistance[ibDdist$hv001.x == ibDdist$hv001.y] <- 0
ibDdist$roaddistance[ibDdist$hv001.x == ibDdist$hv001.y] <- 0
ibDdist$riverdist[ibDdist$hv001.x == ibDdist$hv001.y] <- 0

ibDdist.long <- ibDdist %>% 
  dplyr::select(-c(dplyr::starts_with("hv001"))) %>% 
  expand_distance_matrix(.)

```

<!-- TODO make above imported in already -->

## Bayesian Mixed (Spatial) Modeling/Epi Considerations
Here we will analyze IBD using a traditional epidemiological approach as our outcome is a single measure of within-prov IBD. _Covariates_: Prov Mean observations; _Spatial Autocorrelation_: W (dexp Province). Gaussian Process (Cluster). _Link/family_: Given that we can normalize the IBD pairwise outcome, we will use a log-link and the Gaussian probability family for our generalized linear models. A log-link will be used given the expected exponential relationship of IBD and distance/covariates.   
  
NB, all covariates were taken from open sources including: Malaria Atlas Project, European Space Agency, LAADS/NASA, and OSM (this include prevalence which is not from our lab but from MAP).


## Province Models
### Covariate Considerations
```{r}
#..............................................................
# Import Covariates for Province
#..............................................................
provCovar.raw <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/covar_rasterstack_provlocations_raw.RDS")

# transform covars
provCovar <- provCovar.raw %>%
  dplyr::mutate(
    prev = my.scale(logit(prev, tol = 0.1)),
    precip = my.scale(precip),
    temp = my.scale(temp),
    elev = my.scale(elev),
    crops = my.scale(logit(crops, tol = 0.1)),
    #actuse = my.scale(logit(actuse, tol = 0.1)),
    netuse = my.scale(logit(netuse, tol = 0.1)),
    housing = my.scale(logit(housing, tol = 0.1))
  )


```

Here you can visualize the (scaled) covariate by province. 
**Note, the covariate X were standardized/scaled in order to account to promote model stability.** 
```{r}

provCovar.geo <- provCovar %>% 
  tidyr::gather(., key = "covar", value = "val", 2:ncol(.)) %>% 
  dplyr::left_join(DRCprov, 
                   y = ., by = "adm1name") 
provCovar.geo <- sf::st_as_sf(provCovar.geo)

provCovar.geo %>% 
  ggplot() + 
  geom_sf(aes(fill = val)) +
  facet_wrap(covar ~ .) + 
  scale_fill_distiller("Prevalence", type = "div", palette = "RdYlBu") +
  map_theme +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

```

#### Prevalence
```{r, results='asis'}
DRC.Provmprev <- dplyr::left_join(DRCprov, provCovar, by = "adm1name")
DRC.Provmprev.plotObj <- ggplot() +
  # prettybasemap_nodrc_dark + 
    geom_sf(data = DRC.Provmprev, aes(fill = prev), 
          color = "#525252", size = 0.05) +
    scale_fill_distiller("Prevalence", type = "div", palette = "RdYlBu") 

plot(DRC.Provmprev.plotObj)

```

```{r, results='asis'}
drcadm1names <- tibble::tibble(
  adm1 = DRCprov$adm1name,
  longnum = sf::st_coordinates(sf::st_centroid(DRCprov))[,1],
  latnum = sf::st_coordinates(sf::st_centroid(DRCprov))[,2]
)

DRC.Provmprev <- dplyr::left_join(DRCprov, provCovar, by = "adm1name")
DRC.Provmprev.plotObj.labels <- ggplot() +
  geom_sf(data = DRC.Provmprev, aes(fill = prev), 
          color = "#525252", size = 0.05) +
  ggrepel::geom_text_repel(data = drcadm1names, 
                           aes(x = longnum, y = latnum, label = adm1), fontface = "bold", size = 4) +
  scale_fill_distiller("Prevalence", type = "div", palette = "RdYlBu") 

plot(DRC.Provmprev.plotObj.labels)
```



### Outcome EDA
Looks relatively normal considering... 

#### Distribution of Pairwise IBD by Prov
**NB, zero-truncated (i.e. excluded IBD=0)**.
```{r, results='asis'}

p1 <- mtdt %>% 
  dplyr::select(c("name", "adm1name")) %>% 
  dplyr::rename(smpl1 = name)

p2 <- mtdt %>% 
  dplyr::select(c("name", "adm1name")) %>% 
  dplyr::rename(smpl2 = name)

ibDdist.long.mtdt <- ibDdist.long %>% 
  dplyr::left_join(., y = p1, by = "smpl1") %>% 
  dplyr::left_join(., y = p2, by = "smpl2")  

# because we want to group by ad1name.x 
# we need to use long here
ibDdist.long.mtdt %>% 
  dplyr::filter(malecotf != 0) %>% 
  ggplot() + 
  ggridges::stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = T,
    quantiles = 4, quantile_lines = T, 
    aes(x = malecotf_gens, y = adm1name.x, fill = factor(..quantile..))
  ) +
  scale_fill_viridis_d("Quantiles") +
  ylab("Province") + xlab("Distribution of Generations") +
  plot_theme 
  
```


#### Mean IBD by Prov
```{r}
# because we want to group by ad1name.x 
# we need to use long here
Provmean <- ibDdist.long.mtdt %>% 
  dplyr::group_by(adm1name.x) %>% 
  dplyr::summarise(
    n = n(),
    meanIBD = mean(malecotf),
    seIBD = sd(malecotf)/sqrt(n),
    LL = meanIBD - 1.96*seIBD,
    UL = meanIBD + 1.96*seIBD
  ) %>% 
  dplyr::mutate(adm1name = adm1name.x)

```

```{r, results='asis'}
Provmean %>% 
  dplyr::mutate_if(is.numeric, round, 4) %>% 
  DT::datatable(.,
                rownames = F,
                options = list(
                  searching = F,
                  pageLength = 6,
                  dom = 'Bfrtip',
                  buttons = c('csv'))) 
```



```{r, results='asis'}
DRC.Provmean <- dplyr::left_join(DRCprov, Provmean, by = "adm1name")

DRC.Provmean.plotObj <- ggplot() +
  geom_sf(data = DRC.Provmean, aes(fill = meanIBD), 
          color = "#525252", size = 0.05) +
  scale_fill_viridis_c("Mean IBD") 
  #prettybasemap_nodrc_dark 

```
```{r, results='asis'}

cowplot::plot_grid(DRC.Provmean.plotObj, DRC.Provmprev.plotObj, nrow = 1, align = "v")

```

#### Within IBD by Prov
```{r}
Provwthn <- ibDdist.long.mtdt %>% 
  dplyr::filter(adm1name.x == adm1name.y) %>% 
  dplyr::group_by(adm1name.x) %>% 
  dplyr::summarise(
    wthnn = n(),
    wthnIBD = mean(malecotf),
    wthnseIBD = sd(malecotf)/sqrt(wthnn),
    wthnLL = wthnIBD - 1.96*wthnseIBD,
    wthnUL = wthnIBD + 1.96*wthnseIBD
  ) %>% 
  dplyr::mutate(adm1name = adm1name.x)

```

```{r, results='asis'}
Provwthn %>% 
  dplyr::mutate_if(is.numeric, round, 4) %>% 
  DT::datatable(.,
                rownames = F,
                options = list(
                  searching = F,
                  pageLength = 6,
                  dom = 'Bfrtip',
                  buttons = c('csv'))) 
```



```{r, results='asis'}
DRC.Provwthn <- dplyr::left_join(DRCprov, Provwthn, by = "adm1name")

DRC.Provwthn.plotObj <- ggplot() +
  #prettybasemap_nodrc_dark +
  geom_sf(data = DRC.Provwthn, aes(fill = wthnIBD), 
          color = "#525252", size = 0.05) +
  scale_fill_viridis_c("Within IBD") +

```
```{r, results='asis'}

cowplot::plot_grid(DRC.Provwthn.plotObj, DRC.Provmprev.plotObj, nrow = 1, align = "v")

```

```{r, results='asis'}

cowplot::plot_grid(DRC.Provmean.plotObj, DRC.Provwthn.plotObj, DRC.Provmprev.plotObj, nrow = 1, align = "v")

```
```{r}

jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/provibD_within_prev.jpg", width = 11, height = 8, units = "in", res = 600)
cowplot::plot_grid(DRC.Provmean.plotObj, DRC.Provwthn.plotObj, DRC.Provmprev.plotObj, nrow = 1, align = "v", labels = c("(A)", "(B)", "(C)"))
graphics.off()
```



## Hierarchial Bayesian Spatial Models for Province Gen-Geo 
### Make Model Framework
NB. Using the _Leroux et al. 2000_ specifiation of the Gaussian Markov Random Field, we will allow  $\rho$ to be estimated under the model.

Model form: 
$$Y \sim \beta^{T}X_{predictors} + O_k + \psi_k $$


### MCMC Diagnostics
Note, our goal is to have the effective sample sizes (`n.effective`) to be at least 500 for all parameters. In addition, we will visually check for convergence among the four chains.


```{r}

provmodels <- readRDS("~/Documents/MountPoints/mountedScratchLL/Projects/Space_the_Final_Miptier/results/carbayes_within_prov_models/_rslurm_CARleroux_DICs_within/params.RDS") %>% 
  dplyr::select(c("formula", "outcome", "distcat"))

# get all files
provformlist <- list.files("~/Documents/MountPoints/mountedScratchLL/Projects/Space_the_Final_Miptier/results/carbayes_within_prov_models/_rslurm_CARleroux_DICs_within/",
                           pattern = ".RDS", full.names = T)
provformlist <- provformlist[!grepl("f.RDS|params.RDS", provformlist)]


provformlistdf <- tibble::tibble(
  path = provformlist
  ) %>% 
  dplyr::mutate(fileord = stringr::str_extract(path, "[0-9]+"),
                fileord = as.numeric(fileord)) %>% 
  dplyr::arrange(fileord)

# now get results 
provmodels$results <- unlist(purrr::map(provformlistdf$path, readRDS), 
                             recursive = F)

# now examine models
provmodels$min_nEff <- purrr::map(provmodels$results, function(x){
  return(min(x$n.effective))
})

provmodels$DIC <- purrr::map(provmodels$results, function(x){
  return(unique(x$DIC))
})

# select out what we need
provmodels <- provmodels %>% 
  dplyr::select(-c("results")) %>% 
  tidyr::unnest(cols = c("min_nEff", "DIC")) %>% 
  dplyr::mutate(formula = purrr::map(formula, function(x){
    return(paste(deparse(x), collapse = ""))
  }))

```

#### DICs Slope {.tabset .tabset-fade}
##### Greater Circle DICs 
```{r, results='asis'}

provmodels %>% 
  dplyr::select(c("formula", "distcat", "min_nEff", "DIC")) %>% 
  dplyr::filter(distcat == "gcdistance") %>% 
  DT::datatable(.,
                rownames = F,
                options = list(
                  searching = F,
                  pageLength = 6,
                  dom = 'Bfrtip',
                  buttons = c('csv')))

```

##### Road DICs 
```{r, results='asis'}

provmodels %>% 
  dplyr::select(c("formula", "distcat", "min_nEff", "DIC")) %>% 
  dplyr::filter(distcat == "roaddistance") %>% 
  DT::datatable(.,
                rownames = F,
                options = list(
                  searching = F,
                  pageLength = 6,
                  dom = 'Bfrtip',
                  buttons = c('csv')))

```

##### River DICs 
```{r, results='asis'}

provmodels %>% 
  dplyr::select(c("formula", "distcat", "min_nEff", "DIC")) %>% 
  dplyr::filter(distcat == "riverdistance") %>% 
  DT::datatable(.,
                rownames = F,
                options = list(
                  searching = F,
                  pageLength = 6,
                  dom = 'Bfrtip',
                  buttons = c('csv')))

```

####


### Long Chain Runs
Note, our goal is still to have the effective sample sizes (`n.effective`) to be at least 1,000 for all parameters. In addition, we will visually check for convergence among the four chains.  
  
**Looks like the slope fitting models failed miserably. Going to drop those going forward**. 

##### Long Chain Param Diagnostics
```{r}
provmodels <- readRDS("~/Documents/MountPoints/mountedScratchLL/Projects/Space_the_Final_Miptier/results/carbayes_within_prov_models/carbayes_long_chains_WITHIN.RDS")

```
