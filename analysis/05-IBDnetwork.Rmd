---
output: html_document
editor_options: 
  chunk_output_type: console
---

# IBD Genetic Network
Let's look at the pairiwse IBD genetic network and perform a few network statistics. 

```{r, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide',
                      fig.align = 'center', fig.width = 8, fig.height = 8)
```

```{r}
#---------------------------------------------------------------------------
# Purpose of this script is to convert pairwise IBD
# measures into a centrality index
#----------------------------------------------------------------------------
library(tidyverse)
library(tidygraph)
library(ggraph)
source("~/Documents/GitHub/Space_the_Final_Miptier/R/basics.R")
source("~/Documents/GitHub/Space_the_Final_Miptier/R/themes.R")
source("~/Documents/GitHub/Space_the_Final_Miptier/R/pairwise_helpers.R")
load("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/space_mips_maps_bases.rda")

```

```{r}

drcsmpls <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/distance_data/drcsmpls_foruse.rds") %>%
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::select(c("id", "hv001")) %>% 
  dplyr::rename(name = id)

mtdt <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/sample_metadata.rds") %>% 
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::rename(name = id) %>% 
  dplyr::select(c("name", "country", "hv001", "adm1name", "longnum", "latnum")) %>% 
  dplyr::filter(name %in% drcsmpls$name)

# drc prov for plot
DRCprov <- sf::st_as_sf(readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/gadm/gadm36_COD_1_sp.rds"))
# load pretty map aesthetics 
load("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/space_mips_maps_bases.rda")
```

```{r}
#....................................................................................
# Import Genetic Data
#....................................................................................
ibD <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/bigbarcode_genetic_data/mipanalyzer.DRCibD_polarized_biallelic_processed.long.rds")

# log2 IBD measure
ibD <- ibD %>% 
  dplyr::mutate(malecotf_gens = -log2(malecotf),
                malecotf_gens_inv = 1/malecotf_gens)

# convert to network
ibDnetwork <- ibD %>% 
  dplyr::filter(malecotf_gens != Inf) %>% # log2(0) is inf
  tidygraph::as_tbl_graph(., directed = F)

```


## Centrality Measure, Weighted IBD
```{r}
# extract centrality
centrality_pr_wi <- ibDnetwork %>%
  tidygraph::activate(nodes) %>%
  dplyr::mutate(centrality_pr_wi = tidygraph::centrality_pagerank(weights = malecotf_gens_inv)) %>%
  tibble::as_tibble()

```

### Centrality & the DRC 

```{r, results='asis'}
centrality_pr_wi.mtdt <- left_join(centrality_pr_wi, mtdt, by = "name")

centrality_pr_wi.mtdt %>% 
  ggplot() +
  geom_histogram(aes(x=centrality_pr_wi, y = ..count..)) +
  plot_theme +
  ggtitle("Overall Centrality") +
  xlab("Centrality (page-rank)") + 
  ylab("Count")

```

**Overall, the global page-rank centrality summary statistics that account for IBD (as weights) are:**
```{r, results='asis'}
centrality_pr_wi.mtdt %>% 
  dplyr::select("centrality_pr_wi") %>% 
  summary(.) %>% 
  knitr::kable()

```

#### Province Centrality
```{r, results='asis'}
centrality_pr_wi.mtdt %>% 
  ggplot() +
  ggridges::geom_density_ridges(aes(x=centrality_pr_wi, y = adm1name), alpha = 0.8) +
  plot_theme +
  xlab("Centrality") + 
  theme(axis.title.y = element_blank(),
        legend.position = "none")
  

```

#### Cluster Centrality
```{r}

DRCcentplot <- ggplot() + 
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) + 
  geom_jitter(data = centrality_pr_wi.mtdt, 
              aes(x = longnum, y = latnum, color = centrality_pr_wi),
              width = 0.05, height = 0.05) + 
  scale_color_viridis_c("Centrality") + 
  #prettybasemap_nodrc_dark +
  map_theme +
  theme(
    axis.title = element_blank(),
    legend.text = element_text(angle = 0),
    legend.position = "right") +
  coord_sf(datum=NA)  # to get rid of gridlines

jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_clust_centrality_all.jpg",
     height = 8, width = 8, units = "in", res = 500)
plot(DRCcentplot)
graphics.off()


```

```{r, results='asis'}
plot(DRCcentplot)
```


##### Above Standardized Mean Zero Clusters, Centrality
```{r}

centrality_pr_wi.mtdt$centrality_pr_wi_scaled <- my.scale(centrality_pr_wi.mtdt$centrality_pr_wi)

centrality_pr_wi.mtdt.nz <- centrality_pr_wi.mtdt %>% 
  dplyr::filter(centrality_pr_wi_scaled > 0)

DRCcentplot <- ggplot() + 
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) + 
  geom_jitter(data = centrality_pr_wi.mtdt.nz, 
              aes(x = longnum, y = latnum, color = centrality_pr_wi_scaled),
              width = 0.05, height = 0.05) + 
  scale_color_viridis_c("Centrality") + 
  #prettybasemap_nodrc_dark + 
  map_theme +
  theme(
    axis.title = element_blank(),
    legend.text = element_text(angle = 0),
    legend.position = "right") +
  coord_sf(datum=NA)  # to get rid of gridlines

jpeg("~/Documents/GitHub/Space_the_Final_Miptier/results/figures/DRC_clust_centrality_all_nonzeros.jpg",
     height = 8, width = 8, units = "in", res = 500)
plot(DRCcentplot)
graphics.off()


```

```{r, results='asis'}
plot(DRCcentplot)
```



## **Pruned** IBD Genetic Network
Let's look at IBD genetic network but this time we are going to prune and use a KNN approach. Part of the incentive for a KNN approach is that our MLE estimator is basically limited to detecting 0-5 generations (under the assumption of outcrossing). This creates weights that are orders of magnitude different for small differences in generations. As a result, we may be biasing our greatest component connections to just 0-1 generation edge weights. Here, we will explore the effects of centrality using different K-based approaches. 


## Convert IBD Generations to Pruned Knn Network
```{r}

# this function is obviously not exportable 
prune_dist_via_knn_to_adjacency <- function(distdat, k){
  pairwisecomparisons <- expand_distance_matrix(distdat)
  nodes <- unique(unlist(distdat[,1]))
  
  adjmat <- lapply(nodes, function(node){
    
    # for each node, pull out pairwise comparisons
    nodedf <- pairwisecomparisons %>% 
      dplyr::filter(smpl1 %in% node) %>% 
      dplyr::arrange(malecotf_gens)
    
    nodedf.keep <- nodedf[1:k, ]
    nodedf.away <- nodedf[(k+1):nrow(nodedf), ]
    
    # catch scenario where last K has same values as those in the "away"
    minkval <- nodedf.keep$malecotf[k]
    if(any(minkval ==  nodedf.away$malecotf)){
      # this many rows are needed to be "randomly sampled"
      resamp <- sum(nodedf.keep$malecotf == minkval)
      
      if(k == 1){
        # if k == 1 overwrite previous adj matrix
        # potential nodes that we could have kept (arrange is by alphabet) 
        nodedf.potential <- nodedf[nodedf$malecotf == minkval, ]
        smpls <- sample(1:nrow(nodedf.potential), size = resamp, replace = F)
        nodedf.keep <- nodedf.potential[smpls, ]
        
      } else {
        # update keep df
        nodedf.keep <- nodedf.keep[1:(k-resamp),]
        
        # potential nodes that we could have kept (arrange is by alphabet) 
        nodedf.potential <- nodedf[nodedf$malecotf == minkval, ]
        smpls <- sample(1:nrow(nodedf.potential), size = resamp, replace = F)
        nodedf.newkeep <- nodedf.potential[smpls, ]
        
        # bring it home
        nodedf.keep <- rbind(nodedf.keep, nodedf.newkeep)
      }
      
    }
    # if no ties, just return keep
    return(nodedf.keep)
  })
  
}



```

### Sensitivity Analysis for K

There are several ideas and plots here. (1) Connected Components: You can think of this as a tradeoff between overfitting and capture the true signal in the network; (2) Path lengths -- taking into acount IBD weights, how many generations back are we considering at each K; (3) Betweeness centrality measure -- basically a shortest path algorithm for edges; (4) Closeness centrality -- an average-ish measure of the shortest path relative to all other edges in the network. 

```{r}

wrap_knn_sens <- function(k, distdat){
  adj.list <- prune_dist_via_knn_to_adjacency(distdat = distdat,
                                              k = k)
  
  network <- adj.list %>% 
  dplyr::bind_rows() %>% 
  tidygraph::as_tbl_graph()
  
  # Get the components of an undirected graph
  cl <- igraph::clusters(network)

  # Get edge density in an undirected graph
  edgedens <- igraph::edge_density(network, loops = F)

  
  # weighted path lengths
  overallgens <- network %>% 
    tidygraph::activate(edges) %>% 
    tibble::as_tibble(.) %>% 
    dplyr::summarise(sumgen = sum(malecotf_gens) ) %>% 
    unlist(.)
  
  gensbysmpl <- adj.list %>% 
    dplyr::bind_rows() %>% 
    dplyr::group_by(smpl1) %>% 
    dplyr::summarise(n = n(),
                     sumgen = sum(malecotf_gens),
                     meangen = mean(malecotf_gens),
                     segen = sd(malecotf_gens)/sqrt(n)) 
  
  # centrality measures 
  closenesscent <- network %>% 
    tidygraph::activate(nodes) %>%
  dplyr::mutate(centrality = tidygraph::centrality_closeness(weights = malecotf_gens_inv)) %>%
  tibble::as_tibble()
  
  # centrality measures 
  btwnesscent <- network %>% 
    tidygraph::activate(nodes) %>%
  dplyr::mutate(centrality = tidygraph::centrality_betweenness(weights = malecotf_gens_inv)) %>%
  tibble::as_tibble()
  
  ret <- list(
    network = network,
    components = cl,
    edgedens = edgedens,
    overallgens = overallgens,
    gensbysmpl = gensbysmpl,
    closenesscent = closenesscent,
    btwnesscent = btwnesscent
  )
  
  return(ret)
}

```

```{r}
# run what you brung
paramsdf <- tibble::tibble(k = 1:10)
paramsdf$ret <- purrr::map(paramsdf$k, wrap_knn_sens, distdat = ibD)


# overall gens 
paramsdf$network <- purrr::map(paramsdf$ret, "network")

# number of greatest components
paramsdf$cl <- purrr::map(paramsdf$ret, "components")
paramsdf$cl <- purrr::map(paramsdf$cl, "no")

# overall gens 
paramsdf$overallgens <- purrr::map(paramsdf$ret, "overallgens")

# mean gens 
paramsdf$gensbysmpl <- purrr::map(paramsdf$ret, "gensbysmpl")

# closeness
paramsdf$closenesscent <- purrr::map(paramsdf$ret, "closenesscent")

# betweenness
paramsdf$btwnesscent <- purrr::map(paramsdf$ret, "btwnesscent")

# edge density
paramsdf$edgedens <- purrr::map(paramsdf$ret, "edgedens")

```

```{r}
# look for a point of stabilization, obviously not exportable
prmsdf_plotter <- function(paramsdf){
  plot1 <- paramsdf %>% 
    dplyr::select(c("k", "overallgens")) %>% 
    tidyr::unnest(cols = overallgens) %>% 
    ggplot() + 
    geom_point(aes(x = k, y = overallgens)) + 
    theme_bw() + 
    xlab("K") + ylab("Overall IBD-Gen Sum")
  
   plot2 <- paramsdf %>% 
    dplyr::select(c("k", "gensbysmpl")) %>% 
    tidyr::unnest(cols = gensbysmpl) %>% 
    ggplot() + 
     ggridges::geom_density_ridges_gradient(aes(x = meangen, y = factor(k), 
                                                fill = ..x..)) +
     scale_fill_viridis_c() +
     xlab("Mean Generation Depth") + 
     ylab("K") +
     theme(legend.title = element_blank())
   
  plot3 <- paramsdf %>% 
    dplyr::select(c("k", "gensbysmpl")) %>% 
    tidyr::unnest(cols = gensbysmpl) %>% 
    ggplot() + 
     ggridges::geom_density_ridges_gradient(aes(x = segen, y = factor(k), 
                                                fill = ..x..)) +
     scale_fill_viridis_c() +
     xlab("Standard Error Generation Depth") + 
     ylab("K") +
     theme(legend.title = element_blank())
       
  plot4 <- paramsdf %>% 
    dplyr::select(c("k", "closenesscent")) %>% 
    tidyr::unnest(cols = closenesscent) %>% 
    ggplot() + 
     ggridges::geom_density_ridges_gradient(aes(x = centrality, y = factor(k), 
                                                fill = ..x..)) +
     scale_fill_viridis_c() +
     xlab("Closeness Centrality") + 
     ylab("K") +
     theme(legend.title = element_blank())
  
  
   plot5 <- paramsdf %>% 
    dplyr::select(c("k", "btwnesscent")) %>% 
    tidyr::unnest(cols = btwnesscent) %>% 
    ggplot() + 
     ggridges::geom_density_ridges_gradient(aes(x = centrality, y = factor(k), 
                                                fill = ..x..)) +
     scale_fill_viridis_c() +
     xlab("Betweenness Centrality") + 
     ylab("K") +
     theme(legend.title = element_blank())
   
  plot6 <- paramsdf %>% 
    dplyr::select(c("k", "edgedens")) %>% 
    tidyr::unnest(cols = edgedens) %>% 
    ggplot() + 
    geom_point(aes(x = k, y = edgedens)) + 
    theme_bw() + 
    xlab("K") + ylab("Edge Density")
   
   
   ret <- list(
     indplots = list(plot1, plot2, plot3, plot4, plot5, plot6),
     cowplots = invisible(cowplot::plot_grid(plot1, plot2, plot3, plot4, plot5, plot6, 
                                             align = "v", nrow = 2))
   )
  
}


```
```{r, results='asis'}
prmdsfplot <- prmsdf_plotter(paramsdf)
prmdsfplot$cowplots

```

## Pruned Network
Will use a **k value of 5**. As a result, our network will contain 5 edges per node. At this point, we will drop IBD (i.e. the edge weights) for our centrality measures. 

```{r}

ibD.knn5 <- prune_dist_via_knn_to_adjacency(distdat = ibD,
                                               k = 5) %>% 
  dplyr::bind_rows()

# sanity check
sanitycheck1 <- ibD.knn5 %>% 
  dplyr::group_by(smpl1) %>% 
  dplyr::summarise(n = n())


ibD.knn5 <- ibD.knn5  %>% 
  tidygraph::as_tbl_graph(., directed = F)

```

### Visualizing Pruned Network
This is going to be the obligatory hairball. 
```{r, results='asis'}
ibD.knn5 %>%
  ggraph(layout = 'kk') +
  geom_edge_link(width  = 0.5, color = "#969696", alpha = 0.5) +
  geom_node_point(size = 1) +
  theme_graph()

```

### Pruned Network Centrality
We are going to ignore weights in this case. 
```{r, results='asis'}
centrality_ibD.knn5 <- ibD.knn5 %>%
  dplyr::mutate(pagerankcent = tidygraph::centrality_pagerank(),
                degreecent = tidygraph::centrality_degree(),
                betweennesscent = tidygraph::centrality_betweenness(),
                closenesscent = tidygraph::centrality_closeness()
  )

```

##### Centrality Concordance
```{r, results='asis'}

centrality_ibD.knn5 %>% 
  tidygraph::activate(nodes) %>% 
  dplyr::select(-c("name")) %>% 
  GGally::ggpairs()

```
Note, the betweenness statistic -- which was originally formulated to identify "communicator" or intermediary people that pass on information -- is a good representation of what I think of when I say genetic "hub". The page-rank captures this same "idea" but relies on eigenvectors to capture "influence". As such, page-rank still appears to be the best choice for our model. 


##### Tranform Centrality, Pruned
Log transformation and standardize. 
```{r, results='asis'}

centrality_final <- centrality_ibD.knn5 %>% 
  tidygraph::activate(nodes) %>% 
  dplyr::select(c("name", "pagerankcent")) %>% 
  tibble::as_tibble()


centrality_final$pagerankcent_logitstand <- my.scale(logit(centrality_final$pagerankcent))

ggplot() + 
  geom_histogram(data = centrality_final, 
                 aes(x= pagerankcent_logitstand, y = ..count..)) +
  theme_classic() + 
  xlab("Page-Rank, Logit-Standardized") + 
  ylab("Count") +
  ggtitle("Distribution of Page-Rank Centrality")

```



### Visualizing Centrality, Pruned
```{r, results='asis'}

centrality_final.mtdt <- centrality_final %>% 
  dplyr::left_join(., y = mtdt, by = "name")

ggplot() + 
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  #prettybasemap_nodrc_dark +
  geom_jitter(data = centrality_final.mtdt,
              aes(x = longnum, y = latnum, color = pagerankcent_logitstand),
              width = 0.05, height = 0.05) +
  scale_color_viridis_c("Centrality", option="plasma") +
  ggtitle("Page-Rank Logit-Std Pruned")

```


## Weighted and Pruned Centrality Concordance
```{r}
#..............................................................
# Bring together centrality meaures
#..............................................................

# pruned cent
centrality_final.mtdt <- centrality_final.mtdt %>% 
  dplyr::rename(centrality_pr_knn5 =  pagerankcent,
                centrality_pr_knn5_scaled = pagerankcent_logitstand)

# weighted cent
colnames(centrality_pr_wi.mtdt) # sanity

# bring together
cent_out <- dplyr::left_join(centrality_final.mtdt, centrality_pr_wi.mtdt) %>% 
  dplyr::select(c(colnames(mtdt), dplyr::starts_with("centrality")))
```

```{r, results='asis'}
cent_out %>% 
  ggplot() + 
  geom_point(aes(x = centrality_pr_wi, y = centrality_pr_knn5)) + 
  geom_abline(slope = 1, intercept = 0, color = "#006d2c", alpha = 0.6) +
  xlab("Weighted Centrality") + 
  ylab("Pruned Centrality") 

```


```{r}
dir.create("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/centrality_measures/")
saveRDS(cent_out, file = "~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/centrality_measures/centrality_final_wi_and_knn5.RDS")

```


## IBD Community Detection Algorithms

### IBD Weights Considered
```{r}
ibDnetwork <- ibDnetwork %>%
  mutate(Community = as.factor(tidygraph::group_louvain(weights = malecotf_gens_inv)))
```

```{r, results='asis'}

ibDnetwork.commdetect <- ibDnetwork %>% 
  tidygraph::activate("nodes") %>% 
  tibble::as_tibble()

ibDnetwork.commdetect <- dplyr::left_join(ibDnetwork.commdetect, mtdt, by = "name")

ggplot() + 
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  #prettybasemap_nodrc_dark +
  geom_jitter(data = ibDnetwork.commdetect,
              aes(x = longnum, y = latnum, 
                  color = factor(Community), shape = factor(Community)), 
              alpha = 0.5, width = 0.05, height = 0.05) +
  scale_color_viridis_d("Community") 

```

### IBD Pruned
```{r}

centrality_ibD.knn5 <- centrality_ibD.knn5 %>%
  mutate(Community = as.factor(tidygraph::group_louvain()))

```

```{r, results='asis'}

centrality_ibD.knn5.commdetect <- centrality_ibD.knn5 %>% 
  tidygraph::activate("nodes") %>% 
  tibble::as_tibble()

ibDnetwork.commdetect <- dplyr::left_join(centrality_ibD.knn5.commdetect, mtdt, by = "name")

ggplot() + 
  geom_sf(data = DRCprov, color = "#737373", fill = "#525252", size = 0.05) +
  #prettybasemap_nodrc_dark +
  geom_jitter(data = ibDnetwork.commdetect,
              aes(x = longnum, y = latnum,  
                  color = factor(Community), shape = factor(Community)),  
              alpha = 0.5, width = 0.05, height = 0.05) +
  scale_color_viridis_d("Community") 

```
