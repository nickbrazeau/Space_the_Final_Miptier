---
output: html_document
editor_options: 
  chunk_output_type: console
---

# IBD and Cities

```{r, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide',
                      fig.align = 'center', fig.width = 8, fig.height = 8)
```

```{r}
library(tidyverse)
library(tidygraph)
library(ggraph)
library(raster)
source("~/Documents/GitHub/Space_the_Final_Miptier/R/basics.R")
source("~/Documents/GitHub/Space_the_Final_Miptier/R/themes.R")

```

```{r}
drcsmpls <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/distance_data/drcsmpls_foruse.rds") %>%
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::select(c("id", "hv001")) %>% 
  dplyr::rename(name = id)

mtdt <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/sample_metadata.rds") %>% 
  magrittr::set_colnames(tolower(colnames(.))) %>%
  dplyr::rename(name = id) %>% 
  dplyr::select(c("name", "country", "hv001", "adm1name", "longnum", "latnum")) %>% 
  dplyr::filter(name %in% drcsmpls$name)

# map bases
DRCprov <- sf::st_as_sf(readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/gadm/gadm36_COD_1_sp.rds"))
load("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/space_mips_maps_bases.rda")

# drc cities
drccites <- readxl::read_excel("~/Documents/GitHub/Space_the_Final_Miptier/data/map_bases/DRC_city_coordinates.xlsx") %>% 
  dplyr::mutate(latnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,1] ),
                longnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,2] ) 
                )

# dhs coord points
ge <- sf::st_as_sf(readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/raw_data/dhsdata/datasets/CDGE61FL.rds")) %>% 
  magrittr::set_colnames(tolower(colnames(.))) %>% 
  dplyr::rename(hv001 = dhsclust) 

```

```{r}
# ibd
ibD <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/bigbarcode_genetic_data/mipanalyzer.DRCibD_polarized_biallelic_processed.long.rds")

# log2 IBD measure
ibD <- ibD %>% 
  dplyr::mutate(malecotf_gens = -log2(malecotf),
                malecotf_gens_inv = 1/malecotf_gens)

```

## Urbanicity

```{r}
urban <- raster::raster("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/urbanicity_raster/urbanicity.grd")
urbancatch <- raster::raster("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/urbanicity_raster/urbanicity_binary.grd")

```


```{r, results='asis'}

ggplot() + 
 ggspatial::layer_spatial(data = urban, aes(fill = stat(band1))) +
  scale_fill_distiller("Urbanicity Score", type = "div", palette = "RdYlBu") +
  #prettybasemap_nodrc +
  geom_text(data = drccites, aes(label = city, x = longnum, y=latnum), 
            hjust = 0.5, vjust = 0.5, nudge_y = 0.3, fontface = "bold", alpha = 0.5) +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


ggplot() + 
 ggspatial::layer_spatial(data = urban, aes(fill = stat(band1))) +
  scale_fill_distiller("Urbanicity Score", type = "div", palette = "RdYlBu") +
  #prettybasemap_nodrc +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))

```


### Sampling Locations and Urbanicity
```{r}

ggplot() + 
 ggspatial::layer_spatial(data = urban, aes(fill = stat(band1))) +
  scale_fill_distiller("Urbanicity Score", type = "div", palette = "RdYlBu") +
  #prettybasemap_nodrc +
  geom_jitter(data = mtdt, 
              aes(x = longnum, y = latnum), 
              height = 0.05, width = 0.05, shape = 21,
              color = "#000000", stroke = 0.5, 
              show.legend = F, alpha = 0.8) +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))



```



## Centrality and Cities
```{r}
cent <- readRDS("~/Documents/GitHub/Space_the_Final_Miptier/data/derived_data/centrality_measures/centrality_final_wi_and_knn5.RDS")

```



### Centrality vs. Urbanicity Linear Relationship
```{r}
studyclsts <- unique(mtdt$hv001)

urban.ge <- ge %>% 
  dplyr::mutate(urban_rura_ext = ifelse(urban_rura == "R", 10000, 2000)) %>%
  dplyr::filter(hv001 %in% studyclsts)
  

urbanmean <- rep(NA, nrow(urban.ge)) 
for (i in 1:length(urbanmean)) {
  urbanmean[i] <-  raster::extract(x = urban,
                                   y = sf::as_Spatial(ge$geometry[i]),
                                   buffer = ge$urban_rura_ext[i],
                                   fun = mean, na.rm = T
  )
}
  
urban.ge$urbanmean <- urbanmean

```

```{r, results='asis'}

cent_urban.ge <- left_join(cent, urban.ge, by = "hv001")

p1 <- cent_urban.ge %>% 
  ggplot() + 
  geom_point(aes(x=centrality_pr_wi, y = urbanmean)) +
  xlab("Weighted Centrality") + ylab("Scaled Urbanicity")

p2 <- cent_urban.ge %>% 
  ggplot() + 
  geom_point(aes(x=centrality_pr_knn5, y = urbanmean)) +
  xlab("Pruned Centrality") + ylab("Scaled Urbanicity")

cowplot::plot_grid(p1, p2, align = "h", nrow = 1)

```

To no real surprise, there is not a clear linear relationship between IBD centrality (genetics) and urbanicity. This is likely due to several reasons: (1) Pf transmission intensity is lower in cities, (2) IBD should be greater in lower transmission settings (i.e. this relationship is confounded), (3) Urbanicity is likely not a linear phenomenon; (4) DHS offsets; (5) Mosquito travel 

### Centrality vs. Urbanicity Direct Viz 
```{r, results='asis'}


ggplot() + 
 ggspatial::layer_spatial(data = urban, aes(fill = stat(band1))) +
  scale_fill_distiller("Urbanicity Score", type = "div", palette = "RdYlBu") +
  geom_jitter(data = cent, aes(x=longnum, y=latnum, color = centrality_pr_wi), 
              alpha = 0.8, size = 2, 
              shape = 21, stroke = 0.5,
              width = 0.05, height = 0.05) + 
  #scale_color_distiller("Centrality", type = "div", palette = "RdYlBu") +
  scale_color_viridis_c("Centrality", option = "magma") + 
  #prettybasemap_nodrc +
  ggtitle("Centrality Weighted by IBD") + 
  theme(plot.title = element_text(size = 14, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


ggplot() + 
 ggspatial::layer_spatial(data = urban, aes(fill = stat(band1))) +
  scale_fill_distiller("Urbanicity Score", type = "div", palette = "RdYlBu") +
  geom_jitter(data = cent, aes(x=longnum, y=latnum, color = centrality_pr_knn5), 
              alpha = 0.8, size = 2, 
              shape = 21, stroke = 0.5,
              width = 0.05, height = 0.05) + 
  #scale_color_distiller("Centrality", type = "div", palette = "RdYlBu") +
  scale_color_viridis_c("Centrality", option = "magma") + 
  #prettybasemap_nodrc +
  ggtitle("Centrality Pruned") + 
  theme(plot.title = element_text(size = 14, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))
```

Here we are treating urbanicity as a binary with regions in the top third percentile as "city-like" (1). 

```{r, results='asis'}


ggplot() + 
 ggspatial::layer_spatial(data = urbancatch, aes(fill = stat(band1))) +
  scale_fill_distiller("Urbanicity Catchment", type = "div", palette = "RdYlBu") +
  geom_jitter(data = cent, aes(x=longnum, y=latnum, color = centrality_pr_wi), 
              alpha = 0.8, size = 2, 
              shape = 21, stroke = 0.5,
              width = 0.05, height = 0.05) + 
  #scale_color_distiller("Centrality", type = "div", palette = "RdYlBu") +
  scale_color_viridis_c("Centrality", option = "magma") + 
  #prettybasemap_nodrc +
  ggtitle("Centrality Weighted by IBD") + 
  theme(plot.title = element_text(size = 14, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


ggplot() + 
 ggspatial::layer_spatial(data = urbancatch, aes(fill = stat(band1))) +
  scale_fill_distiller("Urbanicity Catchment", type = "div", palette = "RdYlBu") +
  geom_jitter(data = cent, aes(x=longnum, y=latnum, color = centrality_pr_knn5), 
              alpha = 0.8, size = 2, 
              shape = 21, stroke = 0.5,
              width = 0.05, height = 0.05) + 
  #scale_color_distiller("Centrality", type = "div", palette = "RdYlBu") +
  scale_color_viridis_c("Centrality", option = "magma") + 
  #prettybasemap_nodrc +
  ggtitle("Centrality Pruned") + 
  theme(plot.title = element_text(size = 14, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))
```


